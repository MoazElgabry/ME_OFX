name: Build ME_OpenDRT All Platforms (macOS + Linux + Windows)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  OPENDRT_VERSION: v1.1.0-rc1

jobs:
  build-macos:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            runner: macos-14
            zip_name: ME_OpenDRT_v1.1.0-rc1_macOS_arm64_portable.zip
            artifact_name: ME_OpenDRT-v1.1.0-rc1-macos-arm64
          - arch: x86_64
            runner: macos-15-intel
            zip_name: ME_OpenDRT_v1.1.0-rc1_macOS_x86_64_portable.zip
            artifact_name: ME_OpenDRT-v1.1.0-rc1-macos-x86_64

    runs-on: ${{ matrix.runner }}

    defaults:
      run:
        shell: bash
        working-directory: ME_OpenDRT/source

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Ninja is available
        run: |
          if command -v ninja >/dev/null 2>&1; then
            echo "ninja already available: $(command -v ninja)"
            ninja --version
          else
            brew install ninja
          fi

      - name: Configure
        run: cmake -S . -B build-mac -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0

      - name: Build
        run: cmake --build build-mac --config Release

      - name: Verify bundle outputs
        run: |
          test -f bundle/ME_OpenDRT.ofx.bundle/Contents/MacOS/ME_OpenDRT.ofx
          test -f bundle/ME_OpenDRT.ofx.bundle/Contents/Resources/OpenDRT.metallib
          otool -l bundle/ME_OpenDRT.ofx.bundle/Contents/MacOS/ME_OpenDRT.ofx | grep -A3 LC_BUILD_VERSION | grep -q "minos 13.0"
          strings bundle/ME_OpenDRT.ofx.bundle/Contents/Resources/OpenDRT.metallib | grep -E -q "air64-apple-macosx13(\\.|$)"
          xcrun metal-objdump -t bundle/ME_OpenDRT.ofx.bundle/Contents/Resources/OpenDRT.metallib | grep -q "OpenDRTKernel"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-bundle
          path: ME_OpenDRT/source/bundle/ME_OpenDRT.ofx.bundle

  build-linux:
    strategy:
      fail-fast: false
      matrix:
        variant:
          - id: opencl-cpu
            linux_cuda: "OFF"
            artifact_name: ME_OpenDRT-v1.1.0-rc1-linux-x86_64-opencl-cpu
            archive_name: ME_OpenDRT_v1.1.0-rc1_linux_x86_64_opencl_cpu_portable.tar.gz
          - id: cuda-opencl-cpu
            linux_cuda: "ON"
            artifact_name: ME_OpenDRT-v1.1.0-rc1-linux-x86_64-cuda-opencl-cpu
            archive_name: ME_OpenDRT_v1.1.0-rc1_linux_x86_64_cuda_opencl_cpu_portable.tar.gz

    runs-on: ubuntu-22.04

    defaults:
      run:
        shell: bash
        working-directory: ME_OpenDRT/source

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++ ocl-icd-opencl-dev
          if [ "${{ matrix.variant.linux_cuda }}" = "ON" ]; then
            sudo apt-get install -y nvidia-cuda-toolkit
          fi

      - name: Configure
        run: |
          cmake -S . -B build-linux -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DME_OPENDRT_LINUX_CUDA=${{ matrix.variant.linux_cuda }}

      - name: Build
        run: cmake --build build-linux --config Release -j

      - name: Verify bundle outputs
        run: |
          test -f bundle/ME_OpenDRT.ofx.bundle/Contents/Linux-x86-64/ME_OpenDRT.ofx

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.variant.artifact_name }}-bundle
          path: ME_OpenDRT/source/bundle/ME_OpenDRT.ofx.bundle

  build-windows:
    runs-on: windows-2022

    defaults:
      run:
        shell: powershell
        working-directory: ME_OpenDRT/source

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC dev command prompt
        uses: ilammy/msvc-dev-cmd@v1

      - name: Detect preinstalled CUDA
        id: detect_cuda
        run: |
          $nvcc = Get-Command nvcc -ErrorAction SilentlyContinue
          if ($null -ne $nvcc) {
            "has_cuda=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Found preinstalled nvcc at $($nvcc.Source)"
            & nvcc --version
          } else {
            "has_cuda=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "No preinstalled nvcc found; CUDA toolkit install will run."
          }

      - name: Setup CUDA Toolkit
        if: steps.detect_cuda.outputs.has_cuda != 'true'
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: "12.5.0"
          method: "network"

      - name: Detect preinstalled Ninja
        id: detect_ninja
        run: |
          $ninja = Get-Command ninja -ErrorAction SilentlyContinue
          if ($null -ne $ninja) {
            "has_ninja=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Found preinstalled ninja at $($ninja.Source)"
            & ninja --version
          } else {
            "has_ninja=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "No preinstalled ninja found; install will run."
          }

      - name: Install Ninja
        if: steps.detect_ninja.outputs.has_ninja != 'true'
        run: choco install ninja --no-progress -y

      - name: Configure
        run: cmake -S . -B build-win -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build-win --config Release

      - name: Verify bundle outputs
        run: |
          if (!(Test-Path "bundle/ME_OpenDRT.ofx.bundle/Contents/Win64/ME_OpenDRT.ofx")) {
            throw "Missing Windows plugin binary"
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: ME_OpenDRT-v1.1.0-rc1-windows-x86_64-bundle
          path: ME_OpenDRT/source/bundle/ME_OpenDRT.ofx.bundle

  bundle-all-platforms:
    runs-on: ubuntu-22.04
    needs:
      - build-macos
      - build-linux
      - build-windows

    steps:
      - name: Download all workflow artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          merge-multiple: false

      - name: Build flat all-platform package (no nested archives)
        run: |
          set -euo pipefail
          mkdir -p package-out

          # Locate bundle directories recursively inside each downloaded artifact.
          for d in all-artifacts/*; do
            [ -d "$d" ] || continue
            bn="$(basename "$d")"
            src_bundle="$(find "$d" -type d -name 'ME_OpenDRT.ofx.bundle' -print -quit || true)"
            if [ -n "$src_bundle" ]; then
              cp -a "$src_bundle" "package-out/ME_OpenDRT_${bn}.ofx.bundle"
            fi
          done

          if [ -z "$(find package-out -mindepth 1 -print -quit)" ]; then
            echo "Artifact tree for debugging:"
            find all-artifacts -maxdepth 6 -print || true
            echo "No bundles found in downloaded artifacts."
            exit 1
          fi

          (cd package-out && zip -r ../ME_OpenDRT_v1.1.0-rc1_all_platforms.zip .)

      - name: Upload single all-platform artifact
        uses: actions/upload-artifact@v4
        with:
          name: ME_OpenDRT-v1.1.0-rc1-all-platforms
          path: ME_OpenDRT_v1.1.0-rc1_all_platforms.zip
